---
import clsx from "clsx";
import SponsorCard from "./sponsorCard.astro";
import type { Sponsor } from "./types";

export interface Props {
  sponsors: Sponsor[];
}

const { sponsors } = Astro.props as Props;
---

<div class="w-full cursor-grab overflow-hidden rounded-lg" id="sponsor-slider">
  <div class="flex w-full space-x-5">
    {
      sponsors.map((sponsor) => (
        <div class="w-full shrink-0 first:ml-0 last:mr-0">
          <SponsorCard {...sponsor} />
        </div>
      ))
    }
  </div>

  {/* Pagination */}
  <div class="mb-10 mt-6 flex justify-center">
    {
      sponsors.map((_, idx) => (
        // Larger click area while keeping the visual circles small
        <button
          aria-label={`Scroll to slide ${idx + 1}`}
          class="0 -mx-0.5 p-1.5"
          data-slider-page={idx}
        >
          <div
            class={clsx(
              "aspect-square h-2 rounded-full bg-primary/50 transition-colors ease-in-out [&.active]:bg-primary [&:not(.active)]:hover:bg-white/40",
              {
                active: idx === 0,
              }
            )}
          />
        </button>
      ))
    }
  </div>
</div>

<script>
  import Embla from "embla-carousel";
  import autoplay from "embla-carousel-autoplay";

  const sliderElement = document.getElementById("sponsor-slider");

  if (!sliderElement) throw new Error("Slider is missing");

  const embla = Embla(
    sliderElement,
    {
      skipSnaps: false,
    },
    [
      autoplay({
        delay: 3000,
        stopOnMouseEnter: true,
        stopOnInteraction: false,
      }),
    ]
  );

  const paginationButtons = document.querySelectorAll("[data-slider-page]");

  paginationButtons.forEach((paginationButton) => {
    const page = paginationButton.getAttribute("data-slider-page");

    if (!page) return;

    paginationButton.addEventListener("click", () => {
      embla.scrollTo(+page);
    });
  });

  embla.on("select", () => {
    const previousSlideIndex = embla.previousScrollSnap();
    const previousSlideButton = paginationButtons[previousSlideIndex];

    if (previousSlideButton) {
      previousSlideButton?.firstElementChild?.classList.remove("active");
    }

    const currentSlideIndex = embla.selectedScrollSnap();
    const currentSlideButton = paginationButtons[currentSlideIndex];

    if (currentSlideButton) {
      currentSlideButton?.firstElementChild?.classList.add("active");
    }
  });

  // Disable tab navigation for sponsor slides
  sliderElement.querySelectorAll("a").forEach((a) => {
    a.tabIndex = -1;
  });
</script>
